<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>æœ€ç»ˆç‰ˆ Â· é©¬å¹´æ¸…å•æˆªå›¾</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, -apple-system, 'PingFang SC', sans-serif; }
        body { background: #fae6e0; display: flex; justify-content: center; padding: 20px; }
        #app { max-width: 600px; width: 100%; background: #fff8f5; border-radius: 32px; padding: 24px; border: 1px solid #ffd9cf; }
        
        /* è¿›åº¦æ¡ */
        .progress-title { display: flex; justify-content: space-between; color: #C7452B; font-weight: 600; margin-bottom: 12px; font-size: 16px; }
        .progress-bar-bg { background: #ffe1d6; height: 14px; border-radius: 20px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { width: 0%; height: 14px; background: #C7452B; transition: width 0.3s; }
        .progress-stats { display: flex; justify-content: space-between; font-size: 16px; color: #8B4B3E; }
        .stats-number { font-weight: 700; color: #C7452B; }

        /* å…³å¡å¡ç‰‡ */
        .chapter-card { background: #fff8f5; border: 1px solid #ffd9cf; border-radius: 24px; padding: 18px; margin-bottom: 20px; }
        .chapter-header { display: flex; align-items: center; gap: 12px; cursor: pointer; user-select: none; }
        .chapter-title { font-size: 18px; font-weight: 700; color: #8B4B3E; flex: 1; word-break: break-word; }
        .chapter-progress { background: #ffe1d6; padding: 5px 14px; border-radius: 30px; font-size: 14px; color: #C7452B; font-weight: 600; white-space: nowrap; }
        .chapter-toggle { font-size: 20px; color: #C7452B; width: 24px; text-align: center; }
        .task-list { padding-left: 40px; margin-top: 10px; }
        .task-list.collapsed { display: none; }
        .task-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px dashed #ffd9cf; }
        .task-item input[type="checkbox"] { margin-right: 14px; width: 18px; height: 18px; accent-color: #C7452B; }
        .task-item label { font-size: 16px; color: #5C3D35; line-height: 1.5; cursor: pointer; }

        /* æŒ‰é’®å’Œè„šæ³¨ */
        .action-button { background: linear-gradient(145deg, #C7452B, #E86B4F); border: none; border-radius: 60px; padding: 16px; width: 100%; color: white; font-size: 20px; font-weight: 700; cursor: pointer; margin: 20px 0 10px; border: 1px solid #FFD700; }
        .footer-note { text-align: center; color: #E86B4F; font-size: 15px; margin-top: 8px; }

        /* æµ®å±‚æ ·å¼ */
        .image-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 20000; display: flex;
            justify-content: center; align-items: center; backdrop-filter: blur(4px);
        }
        .image-modal-container {
            background: #fff8f5; border-radius: 32px; max-width: 90%; max-height: 90%;
            display: flex; flex-direction: column; overflow: hidden; border: 2px solid #FFD700;
        }
        .image-modal-body { padding: 20px; text-align: center; }
        .image-modal-body img { max-width: 100%; max-height: 60vh; border-radius: 24px; border: 2px solid #C7452B; }
        .image-modal-footer { padding: 0 20px 20px; text-align: center; }
        .save-tip {
            background: linear-gradient(145deg, #C7452B, #E86B4F); color: white;
            padding: 12px 20px; border-radius: 60px; font-size: 18px; font-weight: 600;
            border: 1px solid #FFD700; margin-bottom: 16px;
        }
        .close-modal-btn {
            background: #fff0e8; border: 2px solid #C7452B; color: #C7452B;
            padding: 10px 30px; border-radius: 40px; font-size: 18px; font-weight: 700;
            cursor: pointer; display: inline-block;
        }

        /* è½»æç¤º */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(199,69,43,0.95); color: white; padding: 12px 24px;
            border-radius: 60px; font-size: 16px; z-index: 999; display: none;
            border: 1px solid #FFD700;
        }
    </style>
    <!-- ä¸»ç”¨ CDN + å¤‡ç”¨åŠ¨æ€åŠ è½½ï¼Œç¡®ä¿ html2canvas ç¨³å®šåŠ è½½ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.6.0/html2canvas.min.js"></script>
    <script>window.html2canvas || document.write('<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.6.0/dist/html2canvas.min.js"><\/script>');</script>
</head>
<body>
<div id="app">
    <!-- è¿›åº¦æ¡æ¨¡å— -->
    <div id="progress-module" style="margin-bottom:20px;">
        <div class="progress-title">
            <span>ğŸ§§ å·²è§£é”å…³å¡</span>
            <span class="stats-number" id="progressCount">0/0</span>
        </div>
        <div class="progress-bar-bg"><div id="progressFill" class="progress-fill"></div></div>
        <div class="progress-stats"><span>ğŸ è¿›åº¦</span><span id="percentDisplay">0%</span></div>
    </div>

    <!-- åŠ¨æ€æ¸²æŸ“æ¸…å•ï¼ˆé»˜è®¤å±•å¼€ï¼‰ -->
    <div id="chapterContainer"></div>

    <!-- ç”Ÿæˆé•¿å›¾æŒ‰é’®ï¼ˆæˆªå›¾æ—¶ä¼šè¢«ç§»é™¤ï¼‰ -->
    <button id="generateBtn" class="action-button">ğŸ§§ ç”Ÿæˆæµ‹è¯•é•¿å›¾</button>
    <div class="footer-note"><span id="selectedCountSmall">0</span>/<span id="totalCountSmall">0</span> å·²å®Œæˆ</div>
</div>

<!-- è½»æç¤º -->
<div id="toast" class="toast"></div>

<script>
(function() {
    // ---------- ç²¾ç®€æ•°æ®ï¼šä¸¤ä¸ªå…³å¡ï¼Œä¾¿äºæµ‹è¯• ----------
    const DEFAULT_CHAPTERS = [
        { icon:"ğŸ¼", name:"ç¬¬ä¸€å…³ï¼šæ–°æ‰‹æ‘", tasks:["å‡ºç”Ÿ","ç¬¬ä¸€æ¬¡å“­","å­¦ä¼šèµ°è·¯","ç¬¬ä¸€æ¬¡å«å¦ˆ"] },
        { icon:"ğŸ“š", name:"ç¬¬äºŒå…³ï¼šæ ¡å›­", tasks:["ä¸Šå°å­¦","ç¬¬ä¸€æ¬¡è€ƒè¯•","æ¯•ä¸š"] }
    ];

    let CHAPTERS = JSON.parse(JSON.stringify(DEFAULT_CHAPTERS));
    let checkedState = [];
    let flatTasks = [];
    let chapterIndexRange = [];
    let chapterCollapsed = {};          // é»˜è®¤å±•å¼€ï¼ˆfalseï¼‰

    // DOM å…ƒç´ 
    const chapterContainer = document.getElementById('chapterContainer');
    const progressCountSpan = document.getElementById('progressCount');
    const selectedCountSmall = document.getElementById('selectedCountSmall');
    const totalCountSmall = document.getElementById('totalCountSmall');
    const progressFill = document.getElementById('progressFill');
    const percentDisplay = document.getElementById('percentDisplay');
    const generateBtn = document.getElementById('generateBtn');
    const toast = document.getElementById('toast');

    // åˆå§‹åŒ–æŠ˜å çŠ¶æ€ï¼ˆå…¨å±•å¼€ï¼‰
    CHAPTERS.forEach((_, idx) => { chapterCollapsed[idx] = false; });

    function rebuildFlatData() {
        flatTasks = [];
        chapterIndexRange = [];
        CHAPTERS.forEach((ch, idx) => {
            const start = flatTasks.length;
            flatTasks = flatTasks.concat(ch.tasks);
            chapterIndexRange.push({ start, end: flatTasks.length - 1 });
        });
        // é‡ç½®å‹¾é€‰çŠ¶æ€ï¼ˆä¿ç•™åŸæœ‰å‹¾é€‰ï¼Œä½†åˆæ¬¡éƒ½æœªå‹¾é€‰ï¼‰
        const newChecked = new Array(flatTasks.length).fill(false);
        if (checkedState.length) {
            for (let i=0; i<Math.min(checkedState.length, flatTasks.length); i++) newChecked[i] = checkedState[i];
        }
        checkedState = newChecked;
        updateProgress();
        render();
    }

    function updateProgress() {
        const checked = checkedState.filter(v=>v).length;
        const total = flatTasks.length;
        const percent = total ? Math.round(checked/total*100) : 0;
        if (progressCountSpan) progressCountSpan.innerText = checked + '/' + total;
        selectedCountSmall.innerText = checked;
        totalCountSmall.innerText = total;
        progressFill.style.width = percent + '%';
        percentDisplay.innerText = percent + '%';
    }

    function getChapterChecked(chapterIdx) {
        const r = chapterIndexRange[chapterIdx];
        if (!r) return 0;
        let cnt = 0;
        for (let i=r.start; i<=r.end; i++) if (checkedState[i]) cnt++;
        return cnt;
    }

    function render() {
        let html = '';
        CHAPTERS.forEach((ch, cIdx) => {
            const total = ch.tasks.length;
            const checked = getChapterChecked(cIdx);
            const collapsed = chapterCollapsed[cIdx];
            html += `<div class="chapter-card">`;
            html += `<div class="chapter-header" onclick="window.toggleChapter(${cIdx})">`;
            html += `<span class="chapter-title">${ch.name}</span>`;
            html += `<span class="chapter-progress">${checked}/${total}</span>`;
            html += `<span class="chapter-toggle">${collapsed ? 'â–¶' : 'â–¼'}</span>`;
            html += `</div>`;
            html += `<div class="task-list ${collapsed ? 'collapsed' : ''}">`;
            ch.tasks.forEach((task, tIdx) => {
                const globalIdx = chapterIndexRange[cIdx]?.start + tIdx;
                const chk = (globalIdx !== undefined && checkedState[globalIdx]) ? 'checked' : '';
                html += `<div class="task-item">`;
                html += `<input type="checkbox" data-chapter="${cIdx}" data-task="${tIdx}" ${chk}>`;
                html += `<label>${task}</label>`;
                html += `</div>`;
            });
            html += `</div></div>`;
        });
        chapterContainer.innerHTML = html;

        // ç»‘å®š checkbox äº‹ä»¶
        document.querySelectorAll('.task-item input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', function(e) {
                const cIdx = parseInt(this.dataset.chapter);
                const tIdx = parseInt(this.dataset.task);
                const globalIdx = chapterIndexRange[cIdx]?.start + tIdx;
                if (globalIdx !== undefined) {
                    checkedState[globalIdx] = this.checked;
                    updateProgress();
                }
            });
        });
    }

    window.toggleChapter = function(idx) {
        chapterCollapsed[idx] = !chapterCollapsed[idx];
        render();
    };

    // ---------- é•¿å›¾ç”Ÿæˆå‡½æ•°ï¼ˆGPTä¼˜åŒ–ç‰ˆï¼Œæ•´åˆè¶…é•¿ä¿æŠ¤ï¼‰ ----------
    async function generateLongImage() {
        // å¦‚æœåº“æœªå®šä¹‰ï¼Œç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼ˆå¤‡ç”¨åŠ è½½å¯èƒ½å¼‚æ­¥ï¼‰
        if (typeof html2canvas === 'undefined') {
            await new Promise(resolve => setTimeout(resolve, 500));
            if (typeof html2canvas === 'undefined') {
                showToast('æˆªå›¾åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•', 2000);
                return;
            }
        }

        // æ£€æµ‹è®¾å¤‡
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        let imgUrl = null;

        try {
            // æ•´ä¸ªå¡ç‰‡å®¹å™¨ï¼ˆåŒ…å«è¿›åº¦æ¡å’Œæ¸…å•ï¼‰
            const questionnaire = document.getElementById('app');

            // åˆ›å»ºå…‹éš†å®¹å™¨
            const container = document.createElement('div');
            container.style.backgroundColor = '#fff8f5';
            container.style.padding = '0';
            container.style.width = questionnaire.offsetWidth + 'px';

            const clone = questionnaire.cloneNode(true);

            // è®©å‹¾é€‰çŠ¶æ€åœ¨ clone é‡Œæ›´ç¨³å®šï¼ˆä¿ç•™ checked å±æ€§ï¼‰
            clone.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.disabled = true;
                if (cb.checked) cb.setAttribute('checked', 'checked');
            });

            // å»æ‰â€œç”Ÿæˆæµ‹è¯•é•¿å›¾â€æŒ‰é’®ï¼Œé¿å…æˆªå›¾é‡Œå‡ºç°
            const btn = clone.querySelector('#generateBtn');
            if (btn) btn.remove();

            container.appendChild(clone);
            container.style.position = 'absolute';
            container.style.left = '-9999px';
            container.style.top = '0';
            document.body.appendChild(container);

            // å¼ºåˆ¶é‡ç»˜
            container.offsetHeight;
            await new Promise(requestAnimationFrame);

            // ç®€å•è¶…é•¿ä¿æŠ¤ï¼ˆiOS ä¸Šé™åˆ¶æ›´ä¸¥ï¼‰
            const maxHeight = isIOS ? 8000 : 20000;
            if (container.scrollHeight > maxHeight) {
                showToast('å†…å®¹è¿‡é•¿ï¼Œè¯·æŠ˜å éƒ¨åˆ†ç« èŠ‚åé‡è¯•', 2000);
                document.body.removeChild(container);
                return;
            }

            // iOS ä½¿ç”¨ scale = 1ï¼Œå…¶ä»–è®¾å¤‡ 1.5
            const scale = isIOS ? 1 : 1.5;

            const canvas = await html2canvas(container, {
                scale,
                backgroundColor: '#fff8f5',
                logging: false,
                useCORS: true
            });

            document.body.removeChild(container);

            // ä½¿ç”¨ blob é¿å… base64 é•¿å­—ç¬¦ä¸²
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png', 1));
            if (!blob) throw new Error('canvas.toBlob failed');

            imgUrl = URL.createObjectURL(blob);

            const saveTip = isMobile ? 'é•¿æŒ‰å›¾ç‰‡ä¿å­˜' : 'å³é”®å¦å­˜ä¸º';

            const overlay = document.createElement('div');
            overlay.className = 'image-modal-overlay';
            overlay.innerHTML = `
                <div class="image-modal-container">
                    <div class="image-modal-body"><img src="${imgUrl}"></div>
                    <div class="image-modal-footer">
                        <div class="save-tip">${saveTip}</div>
                        <div class="close-modal-btn">å…³ é—­</div>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';

            function cleanup() {
                overlay.remove();
                document.body.style.overflow = '';
                if (imgUrl) URL.revokeObjectURL(imgUrl);
                imgUrl = null;
            }

            overlay.addEventListener('click', e => { if (e.target === overlay) cleanup(); });
            overlay.querySelector('.close-modal-btn').addEventListener('click', cleanup);

        } catch (e) {
            console.error('æˆªå›¾å¤±è´¥:', e);
            if (imgUrl) URL.revokeObjectURL(imgUrl);
            showToast('æˆªå›¾å¤±è´¥', 2000);
        }
    }

    function showToast(msg, duration) {
        toast.textContent = msg;
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', duration);
    }

    generateBtn.addEventListener('click', generateLongImage);

    // åˆå§‹åŒ–
    rebuildFlatData();
})();
</script>
</body>
</html>